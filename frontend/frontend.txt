==============================dashboard.html=============================

    <script>
        // ===== Configuration =====
        const WS_URL = 'ws://localhost:8081';
        const API_URL = 'http://localhost:8080';

        // ===== State Variables =====
        let ws = null;
        let currentTripId = null;
        let tripStartTime = null;
        let tripDurationInterval = null;
        let gpsUpdateCount = 0;
        let lastLocation = { lat: 0, lon: 0 };
        let totalDistance = 0;
        let safetyScore = 1000;

        // ===== Authentication Check =====
        const sessionId = localStorage.getItem('session_id');
        const driverId = localStorage.getItem('driver_id');
        const driverName = localStorage.getItem('driver_name');

        if (!sessionId || !driverId) {
            window.location.href = 'login.html';
        }

        // ===== DOM Elements =====
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', function () {
            // Set user info
            if (driverName) {
                userName.textContent = driverName;
                userAvatar.textContent = driverName.charAt(0) + driverName.split(' ')[1]?.charAt(0) || driverName.charAt(1) || driverName.charAt(0);
            }

            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', function () {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (event) {
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            // Initialize WebSocket connection
            connectWebSocket();

            // Load vehicles for dropdown
            loadVehicles();

            // Load initial data
            loadInitialData();

            // Check for active trip
            checkActiveTrip();
        });

        // ===== Load Initial Data =====
        async function loadInitialData() {
            try {
                // Load safety score
                const score = await loadRealSafetyScore();
                safetyScore = score;
                document.getElementById('safetyScore').textContent = score;

                // Load user stats
                await loadUserStats();

                // Initialize GPS if available
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            updateLocationDisplay(position.coords.latitude, position.coords.longitude, position.coords.accuracy);
                        },
                        (error) => {
                            console.log('GPS not available:', error);
                        }
                    );
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // ===== WebSocket Connection =====
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                return;
            }

            updateStatus('wsStatus', 'Connecting...', 'wsStatusDot', false);

            try {
                ws = new WebSocket(WS_URL);

                ws.onopen = function () {
                    console.log('WebSocket connected to bridge');
                    updateStatus('wsStatus', 'Connected', 'wsStatusDot', true);
                    addEvent('WebSocket connected to real-time data stream', 'success');

                    // Send authentication to WebSocket bridge
                    if (sessionId && driverId) {
                        ws.send(JSON.stringify({
                            type: 'auth',
                            session_id: sessionId,
                            driver_id: driverId
                        }));
                    }
                };

                ws.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                ws.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    updateStatus('wsStatus', 'Error', 'wsStatusDot', false);
                    addEvent('WebSocket connection error', 'danger');
                };

                ws.onclose = function () {
                    console.log('WebSocket disconnected');
                    updateStatus('wsStatus', 'Disconnected', 'wsStatusDot', false);
                    setTimeout(connectWebSocket, 3000);
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                setTimeout(connectWebSocket, 5000);
            }
        }

        // ===== WebSocket Message Handler =====
        function handleWebSocketMessage(data) {
            console.log('WebSocket message received:', data);

            switch (data.type) {
                case 'live_data':
                    updateLiveData(data.data);
                    break;

                case 'warning':
                    handleWarning(data.data);
                    break;

                case 'trip_started':
                    handleTripStarted(data.data);
                    break;

                case 'trip_stopped':
                    handleTripStopped(data.data);
                    break;

                case 'safety_score_update':
                    if (data.data && data.data.safety_score) {
                        safetyScore = parseInt(data.data.safety_score);
                        document.getElementById('safetyScore').textContent = safetyScore;
                        console.log('Safety score updated via WebSocket:', safetyScore);
                    }
                    break;

                case 'event':
                    if (data.data && data.data.message) {
                        addEvent(data.data.message, data.data.severity || 'info');
                    }
                    break;
            }
        }

        // ===== Update Live Data =====
        function updateLiveData(data) {
            console.log('Updating live data:', data);

            // Update GPS status
            if (data.latitude && data.longitude) {
                updateStatus('gpsStatus', 'Active', 'gpsStatusDot', true);
                gpsUpdateCount++;
                document.getElementById('gpsUpdates').textContent = gpsUpdateCount;

                // Update location display
                const currentLat = parseFloat(data.latitude);
                const currentLon = parseFloat(data.longitude);

                updateLocationDisplay(currentLat, currentLon, data.accuracy);

                // Calculate distance if trip is active
                if (currentTripId && lastLocation.lat !== 0) {
                    const distance = calculateDistance(
                        lastLocation.lat, lastLocation.lon,
                        currentLat, currentLon
                    );
                    totalDistance += distance;

                    // Update displays
                    document.getElementById('tripDistance').textContent = totalDistance.toFixed(2) + ' km';
                    document.getElementById('distanceTraveled').textContent = totalDistance.toFixed(2);

                    // Log GPS point to backend
                    logGPSPoint(currentLat, currentLon, data.speed || 0, data.acceleration || 0);
                }

                lastLocation = { lat: currentLat, lon: currentLon };
            }

            // Update speed and acceleration
            if (data.speed !== undefined) {
                document.getElementById('speedValue').textContent = Math.round(data.speed);
            }
            if (data.acceleration !== undefined) {
                document.getElementById('accelValue').textContent = parseFloat(data.acceleration).toFixed(1);
            }

            // Update event counts if provided
            if (data.hard_brake_count !== undefined) {
                document.getElementById('hardBrakeCount').textContent = data.hard_brake_count;
            }
            if (data.rapid_accel_count !== undefined) {
                document.getElementById('rapidAccelCount').textContent = data.rapid_accel_count;
            }
            if (data.impact_count !== undefined) {
                document.getElementById('impactCount').textContent = data.impact_count;
            }

            // Update trip status if active
            if (data.trip_active) {
                updateStatus('tripStatus', 'Active', 'tripStatusDot', true);
            }
        }

        // ===== Update Location Display =====
        function updateLocationDisplay(lat, lon, accuracy) {
            document.getElementById('latitude').textContent = lat.toFixed(6);
            document.getElementById('longitude').textContent = lon.toFixed(6);

            if (accuracy && !isNaN(accuracy)) {
                document.getElementById('accuracy').textContent = `${Math.round(accuracy)}m`;
            } else {
                document.getElementById('accuracy').textContent = 'N/A';
            }
        }

        // ===== Handle Warning Events =====
        function handleWarning(data) {
            let message = '';
            let severity = 'warning';
            let pointDeduction = 0;

            switch (data.warning_type) {
                case 'hard_braking':
                    pointDeduction = 10;
                    message = `Hard braking detected: ${parseFloat(data.value).toFixed(2)} m/s² | Score: -${pointDeduction} points`;
                    severity = 'danger';
                    break;
                case 'rapid_acceleration':
                    pointDeduction = 5;
                    message = `Rapid acceleration: ${parseFloat(data.value).toFixed(2)} m/s² | Score: -${pointDeduction} points`;
                    severity = 'warning';
                    break;
                case 'impact':
                    pointDeduction = 50;
                    message = `IMPACT DETECTED: ${parseFloat(data.value).toFixed(2)} m/s² | Score: -${pointDeduction} points | Incident reported`;
                    severity = 'danger';
                    break;
                default:
                    message = `Warning: ${data.warning_type}`;
            }

            // Update safety score
            if (pointDeduction > 0) {
                safetyScore = Math.max(0, safetyScore - pointDeduction);
                document.getElementById('safetyScore').textContent = safetyScore;

                // Report event to backend
                reportEvent(data.warning_type, message, pointDeduction);
            }

            addEvent(message, severity);
        }

        // ===== Report Event to Backend =====
        async function reportEvent(eventType, description, pointDeduction) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'driver_report_event',
                        session_id: sessionId,
                        event_type: eventType,
                        description: description,
                        point_deduction: pointDeduction,
                        trip_id: currentTripId || 0
                    })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    console.log('Event reported to backend:', eventType);
                }
            } catch (error) {
                console.error('Error reporting event:', error);
            }
        }

        // ===== Calculate Distance Between Coordinates =====
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ===== Log GPS Point to Backend =====
        async function logGPSPoint(lat, lon, speed, acceleration = 0) {
            if (!currentTripId) return;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'trip_log_gps',
                        session_id: sessionId,
                        trip_id: currentTripId,
                        latitude: lat,
                        longitude: lon,
                        speed: speed,
                        acceleration: acceleration,
                        timestamp: Date.now() * 1000000
                    })
                });

                const data = await response.json();
                if (data.status !== 'success') {
                    console.error('Failed to log GPS point:', data.message);
                }
            } catch (error) {
                console.error('Error logging GPS point:', error);
            }
        }

        // ===== Trip Started Handler =====
        function handleTripStarted(data) {
            currentTripId = data.trip_id;
            document.getElementById('currentTripId').textContent = currentTripId;
            tripStartTime = Date.now();
            totalDistance = 0;
            gpsUpdateCount = 0;

            // Reset distance display
            document.getElementById('tripDistance').textContent = '0.0 km';
            document.getElementById('distanceTraveled').textContent = '0.0';

            // Get current location for starting point
            const currentLat = parseFloat(document.getElementById('latitude').textContent) || 31.5204;
            const currentLon = parseFloat(document.getElementById('longitude').textContent) || 74.3587;
            lastLocation = { lat: currentLat, lon: currentLon };

            // Update UI
            document.getElementById('startTripBtn').disabled = true;
            document.getElementById('stopTripBtn').disabled = false;
            updateStatus('tripStatus', 'Active', 'tripStatusDot', true);

            addEvent(`Trip ${currentTripId} started`, 'success');

            // Start trip duration timer
            if (tripDurationInterval) clearInterval(tripDurationInterval);
            tripDurationInterval = setInterval(updateTripDuration, 1000);
        }

        // ===== Trip Stopped Handler =====
        function handleTripStopped(data) {
            document.getElementById('startTripBtn').disabled = false;
            document.getElementById('stopTripBtn').disabled = true;
            updateStatus('tripStatus', 'Inactive', 'tripStatusDot', false);

            addEvent(`Trip ${currentTripId} completed - Distance: ${totalDistance.toFixed(2)} km`, 'success');

            // Reset trip variables
            const completedTripId = currentTripId;
            currentTripId = null;
            totalDistance = 0;
            document.getElementById('currentTripId').textContent = 'None';
            document.getElementById('tripDuration').textContent = '00:00:00';
            document.getElementById('tripDistance').textContent = '0.0 km';
            document.getElementById('distanceTraveled').textContent = '0.0';
            document.getElementById('gpsUpdates').textContent = '0';

            // Clear interval
            if (tripDurationInterval) {
                clearInterval(tripDurationInterval);
                tripDurationInterval = null;
            }

            // Refresh stats after trip completion
            loadRealSafetyScore();
            loadUserStats();
        }

        // ===== Update Trip Duration =====
        function updateTripDuration() {
            if (!tripStartTime) return;

            const elapsed = Math.floor((Date.now() - tripStartTime) / 1000);
            const hours = Math.floor(elapsed / 3600);
            const minutes = Math.floor((elapsed % 3600) / 60);
            const seconds = elapsed % 60;

            document.getElementById('tripDuration').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ===== Load Vehicles for Dropdown =====
        async function loadVehicles() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'vehicle_get_list',
                        session_id: sessionId
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.data.vehicles) {
                    const select = document.getElementById('vehicleSelect');
                    select.innerHTML = '<option value="">Select Vehicle...</option>';

                    data.data.vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.vehicle_id;
                        option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.license_plate})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        // ===== Start Trip Function =====
        async function startTrip() {
            const vehicleSelect = document.getElementById('vehicleSelect');
            const vehicleId = vehicleSelect.value;

            if (!vehicleId) {
                alert('Please select a vehicle first');
                return;
            }

            // Disable button immediately to prevent double-clicks
            const startBtn = document.getElementById('startTripBtn');
            startBtn.disabled = true;
            startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

            try {
                // Get current location
                const latitude = parseFloat(document.getElementById('latitude').textContent) || 31.5204;
                const longitude = parseFloat(document.getElementById('longitude').textContent) || 74.3587;

                console.log('Starting trip:', { vehicleId, latitude, longitude });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'trip_start',
                        session_id: sessionId,
                        driver_id: driverId,
                        vehicle_id: parseInt(vehicleId),
                        latitude: latitude,
                        longitude: longitude,
                        address: 'Starting location'
                    })
                });

                const data = await response.json();
                console.log('Trip start response:', data);

                if (data.status === 'success') {
                    // Trip started successfully
                    const tripId = data.data.trip_id;
                    console.log(`Trip ${tripId} started successfully`);

                    // Update UI immediately
                    currentTripId = tripId;
                    document.getElementById('currentTripId').textContent = tripId;
                    tripStartTime = Date.now();
                    totalDistance = 0;

                    // Reset displays
                    document.getElementById('tripDistance').textContent = '0.0 km';
                    document.getElementById('distanceTraveled').textContent = '0.0';
                    lastLocation = { lat: latitude, lon: longitude };

                    // Update buttons
                    startBtn.disabled = true;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Trip';
                    document.getElementById('stopTripBtn').disabled = false;
                    updateStatus('tripStatus', 'Active', 'tripStatusDot', true);

                    addEvent(`Trip ${tripId} started successfully`, 'success');

                    // Start duration timer
                    if (tripDurationInterval) clearInterval(tripDurationInterval);
                    tripDurationInterval = setInterval(updateTripDuration, 1000);

                    // Notify WebSocket bridge
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'trip_started',
                            data: {
                                trip_id: tripId,
                                vehicle_id: parseInt(vehicleId),
                                start_time: tripStartTime
                            }
                        }));
                    }
                } else {
                    // Trip start failed
                    console.error('Trip start failed:', data.message);
                    addEvent(`Failed to start trip: ${data.message || 'Unknown error'}`, 'danger');
                    alert(`Failed to start trip: ${data.message || 'Unknown error'}`);

                    // Re-enable button
                    startBtn.disabled = false;
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start Trip';
                }
            } catch (error) {
                console.error('Error starting trip:', error);
                addEvent(`Error starting trip: ${error.message}`, 'danger');
                alert(`Network error starting trip: ${error.message}`);

                // Re-enable button
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="fas fa-play"></i> Start Trip';
            }
        }

        // ===== Stop Trip Function =====
        async function stopTrip() {
            if (!currentTripId) {
                alert('No active trip to stop');
                return;
            }

            // Disable button immediately
            const stopBtn = document.getElementById('stopTripBtn');
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping...';

            try {
                const latitude = parseFloat(document.getElementById('latitude').textContent) || 31.5204;
                const longitude = parseFloat(document.getElementById('longitude').textContent) || 74.3587;

                console.log('Stopping trip:', { tripId: currentTripId, latitude, longitude, distance: totalDistance });

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'trip_end',
                        session_id: sessionId,
                        trip_id: currentTripId,
                        latitude: latitude,
                        longitude: longitude,
                        distance: totalDistance,
                        address: 'Ending location',
                        duration: tripStartTime ? Math.floor((Date.now() - tripStartTime) / 1000) : 0
                    })
                });

                const data = await response.json();
                console.log('Trip stop response:', data);

                if (data.status === 'success') {
                    console.log(`Trip ${currentTripId} stopped successfully`);

                    // Update UI
                    document.getElementById('startTripBtn').disabled = false;
                    stopBtn.disabled = true;
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Trip';
                    updateStatus('tripStatus', 'Inactive', 'tripStatusDot', false);

                    addEvent(`Trip ${currentTripId} completed - Distance: ${totalDistance.toFixed(2)} km`, 'success');

                    // Notify WebSocket bridge
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'trip_stopped',
                            data: {
                                trip_id: currentTripId,
                                distance: totalDistance,
                                duration: tripStartTime ? Math.floor((Date.now() - tripStartTime) / 1000) : 0
                            }
                        }));
                    }

                    // Reset trip state
                    const completedTripId = currentTripId;
                    currentTripId = null;
                    totalDistance = 0;
                    document.getElementById('currentTripId').textContent = 'None';
                    document.getElementById('tripDuration').textContent = '00:00:00';
                    document.getElementById('tripDistance').textContent = '0.0 km';
                    document.getElementById('distanceTraveled').textContent = '0.0';

                    // Clear interval
                    if (tripDurationInterval) {
                        clearInterval(tripDurationInterval);
                        tripDurationInterval = null;
                    }

                    // Refresh data
                    loadRealSafetyScore();
                    loadUserStats();
                } else {
                    console.error('Trip stop failed:', data.message);
                    addEvent(`Failed to stop trip: ${data.message || 'Unknown error'}`, 'danger');
                    alert(`Failed to stop trip: ${data.message || 'Unknown error'}`);

                    stopBtn.disabled = false;
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Trip';
                }
            } catch (error) {
                console.error('Error stopping trip:', error);
                addEvent(`Error stopping trip: ${error.message}`, 'danger');
                alert(`Network error stopping trip: ${error.message}`);

                stopBtn.disabled = false;
                stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Trip';
            }
        }

        // ===== Update Status Indicator =====
        function updateStatus(elementId, text, dotId, isConnected = true) {
            const element = document.getElementById(elementId);
            const dot = document.getElementById(dotId);

            if (element) {
                element.textContent = text;
            }

            if (dot) {
                if (isConnected) {
                    dot.classList.add('connected');
                } else {
                    dot.classList.remove('connected');
                }
            }
        }

        // ===== Add Event to Events List =====
        function addEvent(message, type = 'info') {
            const eventsList = document.getElementById('eventsList');
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${type}`;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Determine icon based on event type
            let icon = 'fas fa-info-circle';
            if (type === 'warning') icon = 'fas fa-exclamation';
            if (type === 'danger') icon = 'fas fa-times';
            if (type === 'success') icon = 'fas fa-check';

            eventItem.innerHTML = `
            <div class="event-icon">
                <i class="${icon}"></i>
            </div>
            <div class="event-info">
                <div class="event-time">${time}</div>
                <div class="event-message">${message}</div>
            </div>
        `;

            eventsList.insertBefore(eventItem, eventsList.firstChild);

            // Limit to 10 events
            while (eventsList.children.length > 10) {
                eventsList.removeChild(eventsList.lastChild);
            }
        }

        // ===== Load Real Safety Score =====
        async function loadRealSafetyScore() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'driver_get_profile',
                        session_id: sessionId
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.data.safety_score) {
                    safetyScore = parseInt(data.data.safety_score);
                    document.getElementById('safetyScore').textContent = safetyScore;
                    console.log(`Loaded safety score from backend: ${safetyScore}`);
                    return safetyScore;
                } else {
                    console.error('Failed to load safety score:', data.message);
                    return 1000;
                }
            } catch (error) {
                console.error('Error loading safety score:', error);
                return 1000;
            }
        }

        // ===== Load User Statistics =====
        async function loadUserStats() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'trip_get_statistics',
                        session_id: sessionId
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // Update dashboard stats with REAL data
                    document.getElementById('hardBrakeCount').textContent =
                        data.data.hard_brake_count || 0;
                    document.getElementById('rapidAccelCount').textContent =
                        data.data.rapid_accel_count || 0;
                    document.getElementById('impactCount').textContent =
                        data.data.impact_count || 0;

                    console.log('Loaded user stats from backend:', data.data);
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // ===== Check for Active Trip on Page Load =====
        async function checkActiveTrip() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'trip_get_active',
                        session_id: sessionId
                    })
                });

                const data = await response.json();

                if (data.status === 'success' && data.data.trip) {
                    const trip = data.data.trip;
                    console.log('Active trip found:', trip);

                    // Restore trip state
                    currentTripId = trip.trip_id;
                    document.getElementById('currentTripId').textContent = currentTripId;

                    // Calculate duration
                    if (trip.start_time) {
                        const startTime = parseInt(trip.start_time) / 1000000;
                        tripStartTime = startTime;
                    }

                    // Update UI
                    document.getElementById('startTripBtn').disabled = true;
                    document.getElementById('stopTripBtn').disabled = false;
                    updateStatus('tripStatus', 'Active', 'tripStatusDot', true);

                    // Start duration timer
                    if (!tripDurationInterval) {
                        tripDurationInterval = setInterval(updateTripDuration, 1000);
                    }

                    addEvent(`Resumed active trip ${currentTripId}`, 'success');
                }
            } catch (error) {
                console.error('Error checking for active trip:', error);
            }
        }

        // ===== Logout =====
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Close WebSocket
                if (ws) {
                    ws.close();
                }

                // Stop any running intervals
                if (tripDurationInterval) {
                    clearInterval(tripDurationInterval);
                }

                // Send logout request to backend
                fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'user_logout',
                        session_id: sessionId
                    })
                }).finally(() => {
                    // Clear all storage
                    localStorage.clear();
                    sessionStorage.clear();

                    // Clear all cookies
                    document.cookie.split(";").forEach(function (c) {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });

                    // Redirect to login
                    window.location.href = 'login.html';
                });
            }
        }

        // ===== Utility Functions =====
        window.addEventListener('resize', function () {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        });

        // ===== Periodically Sync Data =====
        setInterval(() => {
            if (sessionId) {
                // Sync safety score every 30 seconds
                loadRealSafetyScore();

                // Sync user stats every minute
                loadUserStats();
            }
        }, 30000);
    </script>
============================================expenses.html========================================
 <script>
        // ===== Configuration =====
        const API_URL = 'http://localhost:8080';

        // ===== State Variables =====
        let expenses = [];
        let vehicles = [];
        let filters = {
            category: '-1',
            vehicle: '0',
            timePeriod: '30days',
            startDate: '',
            endDate: ''
        };

        // ===== Authentication Check =====
        const sessionId = localStorage.getItem('session_id');
        const driverId = localStorage.getItem('driver_id');
        const driverName = localStorage.getItem('driver_name');

        if (!sessionId || !driverId) {
            window.location.href = 'login.html';
        }

        // ===== DOM Elements =====
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const expensesList = document.getElementById('expensesList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', function () {
            // Set user info
            if (driverName) {
                userName.textContent = driverName;
                userAvatar.textContent = driverName.charAt(0) + driverName.split(' ')[1]?.charAt(0) || driverName.charAt(1) || driverName.charAt(0);
            }

            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', function () {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (event) {
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            // Initialize date inputs
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
            document.getElementById('endDate').value = formatDateForInput(today);

            // Set default date for expense form
            document.getElementById('expenseDate').value = formatDateForInput(today);

            // Load vehicles and expenses
            loadVehicles();
            loadExpenses();
            loadStatistics();
        });

        // ===== Format Date for Input =====
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // ===== Format Date Display =====
        function formatDateDisplay(timestamp) {
            if (!timestamp || timestamp === '0') return 'N/A';

            // Convert nanoseconds to milliseconds
            const timestampMs = parseInt(timestamp) / 1000000;
            const date = new Date(timestampMs);

            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // ===== Get Category Class =====
        function getCategoryClass(category) {
            const classes = ['category-fuel', 'category-maintenance', 'category-insurance',
                'category-toll', 'category-parking', 'category-other'];
            return classes[parseInt(category)] || 'category-other';
        }

        // ===== Get Category Icon =====
        function getCategoryIcon(category) {
            const icons = ['fas fa-gas-pump', 'fas fa-tools', 'fas fa-shield-alt',
                'fas fa-road', 'fas fa-parking', 'fas fa-money-bill-wave'];
            return icons[parseInt(category)] || 'fas fa-money-bill-wave';
        }

        // ===== Get Category Name =====
        function getCategoryName(category) {
            const names = ['Fuel', 'Maintenance', 'Insurance', 'Toll', 'Parking', 'Other'];
            return names[parseInt(category)] || 'Other';
        }

        // ===== Format Currency =====
        function formatCurrency(amount) {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) return '$0.00';

            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(numAmount);
        }

        // ===== Load Statistics =====
        async function loadStatistics() {
            try {
                // Get date range for statistics
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                // Convert dates to timestamp (nanoseconds)
                const startTimestamp = startDate ? (new Date(startDate).getTime() * 1000000).toString() : '0';
                const endTimestamp = endDate ? (new Date(endDate).getTime() * 1000000).toString() : Date.now().toString() + '000000';

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'expense_get_summary',
                        session_id: sessionId,
                        start_date: startTimestamp,
                        end_date: endTimestamp
                    })
                });

                const data = await response.json();
                console.log('Statistics response:', data);

                if (data.status === 'success') {
                    document.getElementById('totalExpenses').textContent =
                        formatCurrency(data.data.total_expenses || 0);
                    document.getElementById('fuelExpenses').textContent =
                        formatCurrency(data.data.fuel_expenses || 0);
                    document.getElementById('maintenanceExpenses').textContent =
                        formatCurrency(data.data.maintenance_expenses || 0);
                    document.getElementById('totalTransactions').textContent =
                        data.data.total_transactions || 0;
                } else {
                    console.error('Failed to load statistics:', data.message);
                    // Set default values
                    document.getElementById('totalExpenses').textContent = '$0';
                    document.getElementById('fuelExpenses').textContent = '$0';
                    document.getElementById('maintenanceExpenses').textContent = '$0';
                    document.getElementById('totalTransactions').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Error loading statistics', 'error');
            }
        }

        // ===== Load Vehicles =====
        async function loadVehicles() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'vehicle_get_list',
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                console.log('Vehicles response:', data);

                if (data.status === 'success' && data.data.vehicles) {
                    vehicles = data.data.vehicles;
                    populateVehicleSelects();
                } else {
                    console.error('Failed to load vehicles:', data.message);
                    showNotification('Failed to load vehicles', 'error');
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
                showNotification('Error loading vehicles', 'error');
            }
        }

        // ===== Populate Vehicle Selects =====
        function populateVehicleSelects() {
            const selects = ['vehicleFilter', 'expenseVehicle', 'editExpenseVehicle'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'vehicleFilter') {
                    select.innerHTML = '<option value="all">All Vehicles</option>';
                } else {
                    select.innerHTML = '<option value="">Select vehicle...</option>';
                }

                if (vehicles && vehicles.length > 0) {
                    vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.vehicle_id;
                        option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.license_plate})`;
                        select.appendChild(option);
                    });
                } else {
                    console.warn('No vehicles found to populate in select');
                }
            });
        }

        // ===== Load Expenses =====
        async function loadExpenses() {
            try {
                // Show loading state
                loadingState.style.display = 'flex';
                emptyState.style.display = 'none';
                expensesList.innerHTML = '';
                expensesList.appendChild(loadingState);

                // Get filter values
                filters.category = document.getElementById('categoryFilter').value;
                filters.vehicle = document.getElementById('vehicleFilter').value;
                filters.timePeriod = document.getElementById('timeFilter').value;
                filters.startDate = document.getElementById('startDate').value;
                filters.endDate = document.getElementById('endDate').value;

                // Build request body
                const requestBody = {
                    operation: 'expense_get_list',
                    session_id: sessionId,
                    limit: 50
                };

                // Add category filter if not "all"
                if (filters.category !== '-1') {
                    requestBody.category = filters.category;
                }

                // Add vehicle filter if not "all"
                if (filters.vehicle !== 'all') {
                    requestBody.vehicle_id = filters.vehicle;
                }

                // Add date range if specified
                if (filters.startDate) {
                    const startTimestamp = new Date(filters.startDate).getTime() * 1000000;
                    requestBody.start_date = startTimestamp.toString();
                }

                if (filters.endDate) {
                    const endTimestamp = new Date(filters.endDate).getTime() * 1000000;
                    requestBody.end_date = endTimestamp.toString();
                }

                console.log('Loading expenses with filters:', requestBody);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log('Expenses response:', data);

                // Hide loading state
                loadingState.style.display = 'none';

                if (data.status === 'success' && data.data.expenses && data.data.expenses.length > 0) {
                    expenses = data.data.expenses;
                    console.log(`Loaded ${expenses.length} expenses from backend`);
                    displayExpenses(expenses);
                } else {
                    console.log('No expenses found or error:', data.message);
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading expenses:', error);
                loadingState.style.display = 'none';
                showEmptyState();
                showNotification('Error loading expenses', 'error');
            }
        }

        // ===== Show Empty State =====
        function showEmptyState() {
            emptyState.style.display = 'flex';
            expensesList.innerHTML = '';
            expensesList.appendChild(emptyState);
        }

        // ===== Display Expenses =====
        function displayExpenses(expenses) {
            expensesList.innerHTML = '';

            expenses.forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = `expense-item ${getCategoryClass(expense.category)}`;
                expenseItem.setAttribute('data-expense-id', expense.expense_id);

                const categoryIcon = getCategoryIcon(expense.category);
                const categoryName = getCategoryName(expense.category);
                const expenseDate = formatDateDisplay(expense.expense_date);
                const amount = formatCurrency(expense.amount);

                // Find vehicle information
                let vehicleName = `Vehicle #${expense.vehicle_id}`;
                if (vehicles && vehicles.length > 0) {
                    const vehicle = vehicles.find(v => v.vehicle_id == expense.vehicle_id);
                    if (vehicle) {
                        vehicleName = `${vehicle.make} ${vehicle.model}`;
                    }
                }

                expenseItem.innerHTML = `
                <div class="expense-header">
                    <div class="expense-category">
                        <div class="category-icon">
                            <i class="${categoryIcon}"></i>
                        </div>
                        <div class="category-info">
                            <div class="category-name">${categoryName}</div>
                            <div class="expense-date">
                                <i class="far fa-calendar"></i>
                                ${expenseDate}
                            </div>
                        </div>
                    </div>
                    <div class="expense-amount">${amount}</div>
                </div>
                
                <div class="expense-details">
                    <div class="detail-item">
                        <div class="detail-label">Vehicle</div>
                        <div class="detail-value">${vehicleName}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Description</div>
                        <div class="detail-value">${expense.description || 'No description'}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Expense ID</div>
                        <div class="detail-value">#${expense.expense_id}</div>
                    </div>
                    
                    <div class="detail-item">
                        <div class="detail-label">Vehicle ID</div>
                        <div class="detail-value">#${expense.vehicle_id}</div>
                    </div>
                </div>
                
                <div class="expense-actions">
                    <button class="action-btn" onclick="editExpense(${expense.expense_id})">
                        <i class="fas fa-edit"></i>
                        Edit
                    </button>
                    <button class="action-btn delete" onclick="deleteExpense(${expense.expense_id})">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </div>
            `;

                expensesList.appendChild(expenseItem);
            });
        }

        // ===== Show Add Expense Modal =====
        function showAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ===== Close Add Expense Modal =====
        function closeAddExpenseModal() {
            document.getElementById('addExpenseModal').classList.remove('active');
            document.getElementById('expenseForm').reset();
            // Reset date to today
            document.getElementById('expenseDate').value = formatDateForInput(new Date());
            document.body.style.overflow = 'auto';
        }

        // ===== Show Edit Expense Modal =====
        function editExpense(expenseId) {
            const expense = expenses.find(e => e.expense_id == expenseId);
            if (!expense) {
                showNotification('Expense not found', 'error');
                return;
            }

            console.log('Editing expense:', expense);

            document.getElementById('editExpenseId').value = expense.expense_id;
            document.getElementById('editExpenseCategory').value = expense.category;
            document.getElementById('editExpenseVehicle').value = expense.vehicle_id;
            document.getElementById('editExpenseAmount').value = expense.amount;
            document.getElementById('editExpenseDescription').value = expense.description || '';

            // Set date if available
            if (expense.expense_date && expense.expense_date !== '0') {
                const timestampMs = parseInt(expense.expense_date) / 1000000;
                const date = new Date(timestampMs);
                document.getElementById('editExpenseDate').value = formatDateForInput(date);
            } else {
                document.getElementById('editExpenseDate').value = formatDateForInput(new Date());
            }

            document.getElementById('editExpenseModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ===== Close Edit Expense Modal =====
        function closeEditExpenseModal() {
            document.getElementById('editExpenseModal').classList.remove('active');
            document.getElementById('editExpenseForm').reset();
            document.body.style.overflow = 'auto';
        }

        // ===== Add Expense =====
        async function addExpense(event) {
            event.preventDefault();

            const vehicleId = document.getElementById('expenseVehicle').value;
            const category = document.getElementById('expenseCategory').value;
            const amount = document.getElementById('expenseAmount').value;
            const description = document.getElementById('expenseDescription').value;
            const expenseDate = document.getElementById('expenseDate').value;

            // Validate inputs
            if (!vehicleId || !category || !amount || !description) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            const expenseData = {
                operation: 'expense_add',
                session_id: sessionId,
                vehicle_id: vehicleId,
                category: category,
                amount: amountNum.toFixed(2),
                description: description
            };

            // Add date if provided and valid
            if (expenseDate) {
                const date = new Date(expenseDate);
                if (!isNaN(date.getTime())) {
                    expenseData.expense_date = (date.getTime() * 1000000).toString();
                }
            }

            console.log('Adding expense:', expenseData);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });

                const data = await response.json();
                console.log('Add expense response:', data);

                if (data.status === 'success') {
                    showNotification('Expense added successfully!', 'success');
                    closeAddExpenseModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    console.error('Failed to add expense:', data.message);
                    showNotification(`Failed to add expense: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                showNotification('Error adding expense. Please try again.', 'error');
            }
        }

        // ===== Update Expense =====
        async function updateExpense(event) {
            event.preventDefault();

            const expenseId = document.getElementById('editExpenseId').value;
            const vehicleId = document.getElementById('editExpenseVehicle').value;
            const category = document.getElementById('editExpenseCategory').value;
            const amount = document.getElementById('editExpenseAmount').value;
            const description = document.getElementById('editExpenseDescription').value;
            const expenseDate = document.getElementById('editExpenseDate').value;

            // Validate inputs
            if (!expenseId || !vehicleId || !category || !amount || !description) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            const amountNum = parseFloat(amount);
            if (isNaN(amountNum) || amountNum <= 0) {
                showNotification('Please enter a valid amount', 'error');
                return;
            }

            const expenseData = {
                operation: 'expense_update',
                session_id: sessionId,
                expense_id: expenseId,
                vehicle_id: vehicleId,
                category: category,
                amount: amountNum.toFixed(2),
                description: description
            };

            // Add date if provided and valid
            if (expenseDate) {
                const date = new Date(expenseDate);
                if (!isNaN(date.getTime())) {
                    expenseData.expense_date = (date.getTime() * 1000000).toString();
                }
            }

            console.log('Updating expense:', expenseData);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenseData)
                });

                const data = await response.json();
                console.log('Update expense response:', data);

                if (data.status === 'success') {
                    showNotification('Expense updated successfully!', 'success');
                    closeEditExpenseModal();
                    loadExpenses();
                    loadStatistics();
                } else {
                    console.error('Failed to update expense:', data.message);
                    showNotification(`Failed to update expense: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error updating expense:', error);
                showNotification('Error updating expense. Please try again.', 'error');
            }
        }

        // ===== Delete Expense =====
        async function deleteExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense? This action cannot be undone.')) {
                return;
            }

            console.log('Deleting expense:', expenseId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'expense_delete',
                        session_id: sessionId,
                        expense_id: expenseId
                    })
                });

                const data = await response.json();
                console.log('Delete expense response:', data);

                if (data.status === 'success') {
                    showNotification('Expense deleted successfully!', 'success');
                    loadExpenses();
                    loadStatistics();
                } else {
                    console.error('Failed to delete expense:', data.message);
                    showNotification(`Failed to delete expense: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting expense:', error);
                showNotification('Error deleting expense. Please try again.', 'error');
            }
        }

        // ===== Apply Filters =====
        function applyFilters() {
            loadExpenses();
            loadStatistics();
        }

        // ===== Reset Filters =====
        function resetFilters() {
            document.getElementById('categoryFilter').value = '-1';
            document.getElementById('vehicleFilter').value = 'all';
            document.getElementById('timeFilter').value = '30days';

            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').value = formatDateForInput(thirtyDaysAgo);
            document.getElementById('endDate').value = formatDateForInput(today);

            loadExpenses();
            loadStatistics();
        }

        // ===== Show Notification =====
        function showNotification(message, type = 'info') {
            // Remove any existing notification
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            cursor: pointer;
        `;

            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
            notification.innerHTML = `<i class="${icon}"></i> ${message}`;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);

            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            });
        }

        // ===== Check Backend Operations =====
        async function checkBackendOperations() {
            console.log('=== Checking Backend Operations ===');

            const operations = [
                'expense_add',
                'expense_update',
                'expense_delete',
                'expense_get_list',
                'expense_get_summary',
                'vehicle_get_list'
            ];

            for (const op of operations) {
                try {
                    console.log(`Testing operation: ${op}`);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: op,
                            session_id: sessionId
                        })
                    });

                    const data = await response.json();
                    console.log(`${op} response:`, data);

                    if (data.status === 'error' && data.message && data.message.includes('Unknown operation')) {
                        console.error(`❌ ${op} NOT IMPLEMENTED in backend`);
                    } else if (data.status === 'success') {
                        console.log(`✓ ${op} SUCCESS`);
                    } else {
                        console.warn(`⚠ ${op} returned:`, data.message);
                    }
                } catch (error) {
                    console.error(`❌ ${op} ERROR:`, error);
                }
            }
        }

        // Uncomment to debug backend operations
        // window.addEventListener('load', checkBackendOperations);

        // ===== Logout =====
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.clear();

                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // ===== Utility Functions =====
        window.addEventListener('resize', function () {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = 'auto';
            }
        });
    </script>


    ========================================leaderboard.html============================================

    <script>
        // ===== Configuration =====
        const API_URL = 'http://localhost:8080';

        // ===== State Variables =====
        let leaderboardData = [];
        let currentFilters = {
            sortBy: 'score',
            timePeriod: 'all',
            driverType: 'all'
        };
        let yourRank = 0;
        let yourScore = 1000;
        let yourPercentile = 0;

        // ===== Authentication Check =====
        const sessionId = localStorage.getItem('session_id');
        const driverId = localStorage.getItem('driver_id');
        const driverName = localStorage.getItem('driver_name');

        if (!sessionId || !driverId) {
            window.location.href = 'login.html';
        }

        // ===== DOM Elements =====
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const loadingState = document.getElementById('loadingState');
        const podiumSection = document.getElementById('podiumSection');
        const leaderboardSection = document.getElementById('leaderboardSection');
        const emptyState = document.getElementById('emptyState');

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', function () {
            // Set user info
            if (driverName) {
                userName.textContent = driverName;
                userAvatar.textContent = driverName.charAt(0) + driverName.split(' ')[1]?.charAt(0) || driverName.charAt(1) || driverName.charAt(0);
            }

            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', function () {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (event) {
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            // Load leaderboard data
            loadLeaderboard();
        });

        // ===== Load Leaderboard =====
        async function loadLeaderboard() {
            try {
                // Show loading state
                loadingState.style.display = 'flex';
                podiumSection.style.display = 'none';
                leaderboardSection.style.display = 'none';
                emptyState.style.display = 'none';

                // Get filter values
                currentFilters.sortBy = document.getElementById('sortFilter').value;
                currentFilters.timePeriod = document.getElementById('timeFilter').value;
                currentFilters.driverType = document.getElementById('driverFilter').value;

                console.log('Loading leaderboard with filters:', currentFilters);

                // Build request body
                const requestBody = {
                    operation: 'driver_get_leaderboard',
                    session_id: sessionId,
                    limit: 100
                };

                // Add filters if specified
                if (currentFilters.sortBy !== 'score') {
                    requestBody.sort_by = currentFilters.sortBy;
                }

                if (currentFilters.timePeriod !== 'all') {
                    requestBody.time_period = currentFilters.timePeriod;
                }

                console.log('Leaderboard request:', requestBody);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                // Check if response is OK
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Leaderboard API response:', data);

                // Hide loading state
                loadingState.style.display = 'none';

                if (data.status === 'success' && data.data && data.data.leaderboard) {
                    leaderboardData = data.data.leaderboard;
                    console.log(`Loaded ${leaderboardData.length} drivers from backend`);

                    if (leaderboardData.length === 0) {
                        showEmptyState();
                        return;
                    }

                    // Process and validate data
                    processLeaderboardData();

                    // Update user stats
                    updateUserStats();

                    // Display leaderboard
                    displayPodium();
                    displayLeaderboard();

                    // Show content
                    podiumSection.style.display = 'block';
                    leaderboardSection.style.display = 'block';
                    emptyState.style.display = 'none';
                } else {
                    console.error('Backend did not return leaderboard data:', data.message || 'No data');
                    showEmptyState();

                    if (data.message && data.message.includes('Unknown operation')) {
                        showNotification('Leaderboard feature not implemented yet', 'warning');
                    }
                }
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                loadingState.style.display = 'none';
                showEmptyState();
                showNotification(`Failed to load leaderboard: ${error.message}`, 'error');
            }
        }

        // ===== Process and Validate Leaderboard Data =====
        function processLeaderboardData() {
            // Ensure all required fields exist and are properly formatted
            leaderboardData = leaderboardData.map((driver, index) => {
                return {
                    driver_id: driver.driver_id || `unknown_${index}`,
                    driver_name: driver.driver_name || 'Unknown Driver',
                    safety_score: parseInt(driver.safety_score) || 1000,
                    total_distance: parseFloat(driver.total_distance) || 0,
                    total_trips: parseInt(driver.total_trips) || 0,
                    avg_speed: parseFloat(driver.avg_speed) || 0,
                    rank: parseInt(driver.rank) || (index + 1),
                    percentile: parseFloat(driver.percentile) || 0
                };
            });

            // Sort by rank if not already sorted
            leaderboardData.sort((a, b) => a.rank - b.rank);

            // Calculate percentiles if not provided
            if (!leaderboardData[0].percentile || leaderboardData[0].percentile === 0) {
                const totalDrivers = leaderboardData.length;
                leaderboardData.forEach((driver, index) => {
                    driver.percentile = ((totalDrivers - index) / totalDrivers) * 100;
                });
            }
        }

        // ===== Update User Stats =====
        function updateUserStats() {
            // Try to find current driver in leaderboard
            const currentDriver = leaderboardData.find(driver =>
                driver.driver_id == driverId ||
                driver.driver_name === driverName
            );

            if (currentDriver) {
                yourRank = currentDriver.rank;
                yourScore = currentDriver.safety_score;
                yourPercentile = currentDriver.percentile;
            } else {
                // If not in leaderboard, load from profile
                loadDriverProfile();
                return;
            }

            console.log(`Current driver stats: Rank ${yourRank}, Score ${yourScore}, Percentile ${yourPercentile}`);

            // Update hero section
            document.getElementById('yourRank').textContent = `#${yourRank}`;
            document.getElementById('yourScore').textContent = yourScore;
            document.getElementById('yourPercentile').textContent = `Top ${yourPercentile.toFixed(1)}%`;
        }

        // ===== Load Driver Profile as Fallback =====
        async function loadDriverProfile() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'driver_get_profile',
                        session_id: sessionId
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    yourScore = parseInt(data.data.safety_score) || 1000;
                    document.getElementById('yourScore').textContent = yourScore;
                    document.getElementById('yourRank').textContent = '#-';
                    document.getElementById('yourPercentile').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Error loading driver profile:', error);
            }
        }

        // ===== Display Podium =====
        function displayPodium() {
            const podiumContainer = document.getElementById('podiumContainer');
            podiumContainer.innerHTML = '';

            // Get top 3 drivers
            const top3 = leaderboardData.slice(0, 3);

            top3.forEach((driver, index) => {
                const podiumCard = document.createElement('div');
                const podiumClass = ['first', 'second', 'third'][index];
                const rankEmoji = ['🥇', '🥈', '🥉'][index];

                // Get initials for avatar
                const initials = driver.driver_name
                    .split(' ')
                    .map(name => name.charAt(0))
                    .join('')
                    .toUpperCase()
                    .slice(0, 2);

                podiumCard.className = `podium-card ${podiumClass}`;
                podiumCard.innerHTML = `
                <div class="rank-badge">${rankEmoji}</div>
                <div class="driver-avatar">${initials}</div>
                <div class="driver-name">${driver.driver_name}</div>
                <div class="driver-score">${driver.safety_score}</div>
                <div class="driver-distance">${Math.round(driver.total_distance).toLocaleString()} km</div>
                
                <div class="driver-stats">
                    <div class="stat-item">
                        <div class="stat-item-label">Trips</div>
                        <div class="stat-item-value">${driver.total_trips || 0}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Avg Speed</div>
                        <div class="stat-item-value">${driver.avg_speed ? Math.round(driver.avg_speed) : 0} km/h</div>
                    </div>
                </div>
            `;

                podiumContainer.appendChild(podiumCard);
            });

            // If less than 3 drivers, add placeholder cards
            for (let i = top3.length; i < 3; i++) {
                const podiumCard = document.createElement('div');
                podiumCard.className = `podium-card ${['first', 'second', 'third'][i]} empty`;
                podiumCard.innerHTML = `
                <div class="rank-badge">${['🥇', '🥈', '🥉'][i]}</div>
                <div class="driver-avatar">--</div>
                <div class="driver-name">No Driver</div>
                <div class="driver-score">0</div>
                <div class="driver-distance">0 km</div>
                
                <div class="driver-stats">
                    <div class="stat-item">
                        <div class="stat-item-label">Trips</div>
                        <div class="stat-item-value">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-item-label">Avg Speed</div>
                        <div class="stat-item-value">0 km/h</div>
                    </div>
                </div>
            `;
                podiumContainer.appendChild(podiumCard);
            }
        }

        // ===== Display Leaderboard Table =====
        function displayLeaderboard() {
            const tableBody = document.getElementById('leaderboardTableBody');
            const leaderboardCount = document.getElementById('leaderboardCount');

            tableBody.innerHTML = '';

            // Update count
            leaderboardCount.textContent = `${leaderboardData.length} drivers ranked`;

            leaderboardData.forEach((driver, index) => {
                const row = document.createElement('tr');

                // Check if this is the current user
                const isCurrentUser = driver.driver_id == driverId || driver.driver_name === driverName;
                if (isCurrentUser) {
                    row.classList.add('highlight');
                }

                // Add rank class for top 3
                if (driver.rank === 1) row.classList.add('rank-1');
                if (driver.rank === 2) row.classList.add('rank-2');
                if (driver.rank === 3) row.classList.add('rank-3');

                // Get initials for avatar
                const initials = driver.driver_name
                    .split(' ')
                    .map(name => name.charAt(0))
                    .join('')
                    .toUpperCase()
                    .slice(0, 2);

                // Calculate score percentage for progress bar (assuming max score is 1000)
                const scorePercentage = Math.min((driver.safety_score / 1000) * 100, 100);

                // Ensure percentile is a number and format it
                const percentileValue = parseFloat(driver.percentile) || 0;
                const percentileText = isNaN(percentileValue) ? 'N/A' : `Top ${percentileValue.toFixed(1)}%`;

                row.innerHTML = `
                <td class="rank-cell ${driver.rank <= 3 ? 'top-3' : ''}">
                    #${driver.rank}
                </td>
                <td>
                    <div class="driver-cell">
                        <div class="driver-avatar-small">${initials}</div>
                        <div class="driver-info">
                            <div class="driver-name-small">
                                ${driver.driver_name}
                                ${isCurrentUser ? '<span class="you-badge">You</span>' : ''}
                            </div>
                            <div class="driver-id">ID: ${driver.driver_id}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="score-cell">${driver.safety_score}</div>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${scorePercentage}%"></div>
                    </div>
                </td>
                <td>
                    <div style="font-size: 16px; font-weight: 600; color: var(--dark);">
                        ${Math.round(driver.total_distance).toLocaleString()} km
                    </div>
                    <div style="font-size: 12px; color: var(--gray);">
                        ${driver.total_trips || 0} trips
                    </div>
                </td>
                <td class="percentile-cell">
                    <div class="percentile-badge">${percentileText}</div>
                </td>
            `;

                tableBody.appendChild(row);
            });
        }

        // ===== Show Empty State =====
        function showEmptyState() {
            loadingState.style.display = 'none';
            podiumSection.style.display = 'none';
            leaderboardSection.style.display = 'none';
            emptyState.style.display = 'flex';
        }

        // ===== Apply Filters =====
        function applyFilters() {
            // Show loading state
            loadingState.style.display = 'flex';
            podiumSection.style.display = 'none';
            leaderboardSection.style.display = 'none';
            emptyState.style.display = 'none';

            // Load data with new filters
            loadLeaderboard();
        }

        // ===== Reset Filters =====
        function resetFilters() {
            document.getElementById('sortFilter').value = 'score';
            document.getElementById('timeFilter').value = 'all';
            document.getElementById('driverFilter').value = 'all';

            applyFilters();
        }

        // ===== Show Notification =====
        function showNotification(message, type = 'info') {
            // Remove any existing notification
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#007bff'};
            color: ${type === 'warning' ? '#212529' : 'white'};
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            cursor: pointer;
        `;

            const icon = type === 'success' ? 'fas fa-check-circle' :
                type === 'error' ? 'fas fa-exclamation-circle' :
                    type === 'warning' ? 'fas fa-exclamation-triangle' :
                        'fas fa-info-circle';
            notification.innerHTML = `<i class="${icon}"></i> ${message}`;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);

            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            });
        }

        // ===== Logout =====
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.clear();

                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // ===== Utility Functions =====
        window.addEventListener('resize', function () {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        });

        // ===== Debug Backend Operations =====
        async function debugBackendOperations() {
            console.log('=== DEBUGGING BACKEND OPERATIONS ===');

            const operations = [
                'driver_get_leaderboard',
                'driver_get_profile',
                'trip_get_statistics',
                'vehicle_get_list'
            ];

            for (const op of operations) {
                try {
                    console.log(`Testing operation: ${op}`);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: op,
                            session_id: sessionId
                        })
                    });

                    const data = await response.json();
                    console.log(`${op} response:`, data);

                    if (data.status === 'error' && data.message) {
                        console.error(`❌ ${op} FAILED:`, data.message);
                        if (data.message.includes('Unknown operation')) {
                            console.error(`   This operation needs to be implemented in backend!`);
                        }
                    } else if (data.status === 'success') {
                        console.log(`✓ ${op} SUCCESS`);
                    }
                } catch (error) {
                    console.error(`❌ ${op} ERROR:`, error);
                }
            }
        }

        // Uncomment to debug backend operations on load
        // window.addEventListener('load', debugBackendOperations);

        // ===== Fallback Data for Testing =====
        function getFallbackLeaderboardData() {
            return [
                {
                    driver_id: driverId,
                    driver_name: driverName,
                    safety_score: 950,
                    total_distance: 12850,
                    total_trips: 142,
                    avg_speed: 58,
                    rank: 5,
                    percentile: 94.8
                },
                {
                    driver_id: '2',
                    driver_name: 'Sarah Johnson',
                    safety_score: 980,
                    total_distance: 15420,
                    total_trips: 165,
                    avg_speed: 55,
                    rank: 1,
                    percentile: 99.5
                },
                {
                    driver_id: '3',
                    driver_name: 'Mike Chen',
                    safety_score: 965,
                    total_distance: 13200,
                    total_trips: 148,
                    avg_speed: 60,
                    rank: 2,
                    percentile: 97.2
                },
                {
                    driver_id: '4',
                    driver_name: 'Emma Wilson',
                    safety_score: 955,
                    total_distance: 11800,
                    total_trips: 135,
                    avg_speed: 52,
                    rank: 3,
                    percentile: 95.8
                },
                {
                    driver_id: '5',
                    driver_name: 'David Brown',
                    safety_score: 940,
                    total_distance: 9800,
                    total_trips: 112,
                    avg_speed: 57,
                    rank: 4,
                    percentile: 93.5
                }
            ];
        }

        // ===== Load Fallback Data (for testing when backend is down) =====
        function loadFallbackData() {
            console.log('Loading fallback leaderboard data for testing');

            leaderboardData = getFallbackLeaderboardData();

            // Update user stats
            updateUserStats();

            // Display leaderboard
            displayPodium();
            displayLeaderboard();

            // Show content
            loadingState.style.display = 'none';
            podiumSection.style.display = 'block';
            leaderboardSection.style.display = 'block';
            emptyState.style.display = 'none';

            showNotification('Using demo data - Backend connection failed', 'warning');
        }

        // Uncomment to use fallback data for testing
        // window.addEventListener('load', function() {
        //     // Try to load real data first, fall back to demo data
        //     setTimeout(() => {
        //         if (leaderboardData.length === 0) {
        //             loadFallbackData();
        //         }
        //     }, 3000);
        // });
    </script>
    ====================================================incidents.html=====================================

    <script>
        // ===== Configuration =====
        const API_URL = 'http://localhost:8080';

        // ===== State Variables =====
        let incidents = [];
        let vehicles = [];
        let filters = {
            type: 'all',
            status: 'all',
            vehicle: 'all'
        };

        // ===== Authentication Check =====
        const sessionId = localStorage.getItem('session_id');
        const driverId = localStorage.getItem('driver_id');
        const driverName = localStorage.getItem('driver_name');

        if (!sessionId || !driverId) {
            window.location.href = 'login.html';
        }

        // ===== DOM Elements =====
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.querySelector('.sidebar');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const incidentsList = document.getElementById('incidentsList');
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');

        // ===== Initialize =====
        document.addEventListener('DOMContentLoaded', function () {
            // Set user info
            if (driverName) {
                userName.textContent = driverName;
                userAvatar.textContent = driverName.charAt(0) + driverName.split(' ')[1]?.charAt(0) || driverName.charAt(1) || driverName.charAt(0);
            }

            // Mobile menu toggle
            mobileMenuBtn.addEventListener('click', function () {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function (event) {
                if (window.innerWidth <= 992) {
                    if (!sidebar.contains(event.target) && !mobileMenuBtn.contains(event.target)) {
                        sidebar.classList.remove('active');
                    }
                }
            });

            // Initialize date inputs
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
            document.getElementById('endDate').valueAsDate = today;

            // Load vehicles, incidents, and statistics
            loadVehicles();
            loadIncidents();
            loadStatistics();
        });

        // ===== Format Date Display =====
        function formatDateDisplay(timestamp) {
            if (!timestamp || timestamp === '0') return 'N/A';

            try {
                // Handle nanoseconds timestamp
                const timestampMs = parseInt(timestamp) / 1000000;
                const date = new Date(timestampMs);

                return date.toLocaleDateString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'Invalid Date';
            }
        }

        // ===== Get Incident Type Class =====
        function getIncidentTypeClass(type) {
            const classes = ['incident-accident', 'incident-breakdown', 'incident-theft',
                'incident-vandalism', 'incident-violation', 'incident-other'];
            return classes[parseInt(type)] || 'incident-other';
        }

        // ===== Get Incident Type Icon =====
        function getIncidentTypeIcon(type) {
            const icons = ['fas fa-car-crash', 'fas fa-tools', 'fas fa-user-secret',
                'fas fa-vandalism', 'fas fa-traffic-light', 'fas fa-exclamation-circle'];
            return icons[parseInt(type)] || 'fas fa-exclamation-circle';
        }

        // ===== Get Incident Type Name =====
        function getIncidentTypeName(type) {
            const names = ['Accident', 'Breakdown', 'Theft', 'Vandalism', 'Traffic Violation', 'Other'];
            return names[parseInt(type)] || 'Other';
        }

        // ===== Get Status Class =====
        function getStatusClass(status) {
            if (status === 'resolved' || status === '1') return 'status-resolved';
            if (status === 'investigating' || status === '2') return 'status-investigating';
            return 'status-pending';
        }

        // ===== Get Status Text =====
        function getStatusText(status) {
            if (status === 'resolved' || status === '1') return 'Resolved';
            if (status === 'investigating' || status === '2') return 'Investigating';
            return 'Pending';
        }

        // ===== Load Statistics =====
        async function loadStatistics() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'incident_get_statistics',
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                console.log('Incident statistics response:', data);

                if (data.status === 'success') {
                    document.getElementById('totalIncidents').textContent = data.data.total_incidents || 0;
                    document.getElementById('totalAccidents').textContent = data.data.total_accidents || 0;
                    document.getElementById('totalBreakdowns').textContent = data.data.total_breakdowns || 0;
                    document.getElementById('unresolvedCount').textContent = data.data.unresolved_incidents || 0;
                } else {
                    console.error('Failed to load statistics:', data.message);
                    // Set default values
                    document.getElementById('totalIncidents').textContent = '0';
                    document.getElementById('totalAccidents').textContent = '0';
                    document.getElementById('totalBreakdowns').textContent = '0';
                    document.getElementById('unresolvedCount').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // ===== Load Vehicles =====
        async function loadVehicles() {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'vehicle_get_list',
                        session_id: sessionId
                    })
                });

                const data = await response.json();
                console.log('Vehicles response:', data);

                if (data.status === 'success' && data.data.vehicles) {
                    vehicles = data.data.vehicles;
                    populateVehicleSelects();
                } else {
                    console.error('Failed to load vehicles:', data.message);
                }
            } catch (error) {
                console.error('Error loading vehicles:', error);
            }
        }

        // ===== Populate Vehicle Selects =====
        function populateVehicleSelects() {
            const selects = ['vehicleFilter', 'vehicleSelect'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'vehicleFilter') {
                    select.innerHTML = '<option value="all">All Vehicles</option>';
                } else {
                    select.innerHTML = '<option value="">Select vehicle...</option>';
                }

                if (vehicles && vehicles.length > 0) {
                    vehicles.forEach(vehicle => {
                        const option = document.createElement('option');
                        option.value = vehicle.vehicle_id;
                        option.textContent = `${vehicle.make} ${vehicle.model} (${vehicle.license_plate})`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // ===== Load Incidents =====
        async function loadIncidents() {
            try {
                // Show loading state
                loadingState.style.display = 'flex';
                emptyState.style.display = 'none';
                incidentsList.innerHTML = '';
                incidentsList.appendChild(loadingState);

                // Get filter values
                filters.type = document.getElementById('typeFilter').value;
                filters.status = document.getElementById('statusFilter').value;
                filters.vehicle = document.getElementById('vehicleFilter').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                console.log('Loading incidents with filters:', filters);

                // Build request body
                const requestBody = {
                    operation: 'incident_get_list',
                    session_id: sessionId,
                    limit: 100
                };

                // Add filters if not "all"
                if (filters.type !== 'all') {
                    requestBody.type = filters.type;
                }

                if (filters.status !== 'all') {
                    // Convert status text to backend format
                    if (filters.status === 'pending') requestBody.status = '0';
                    if (filters.status === 'resolved') requestBody.status = '1';
                    if (filters.status === 'investigating') requestBody.status = '2';
                }

                if (filters.vehicle !== 'all') {
                    requestBody.vehicle_id = filters.vehicle;
                }

                // Add date range if provided
                if (startDate) {
                    const startTimestamp = new Date(startDate).getTime() * 1000000;
                    requestBody.start_date = startTimestamp.toString();
                }

                if (endDate) {
                    const endTimestamp = new Date(endDate).getTime() * 1000000;
                    requestBody.end_date = endTimestamp.toString();
                }

                console.log('Incident request body:', requestBody);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                console.log('Incidents response:', data);

                // Hide loading state
                loadingState.style.display = 'none';

                if (data.status === 'success' && data.data.incidents && data.data.incidents.length > 0) {
                    incidents = data.data.incidents;
                    console.log(`Loaded ${incidents.length} incidents from backend`);
                    displayIncidents(incidents);
                } else {
                    console.log('No incidents found or error:', data.message);
                    showEmptyState();
                }
            } catch (error) {
                console.error('Error loading incidents:', error);
                loadingState.style.display = 'none';
                showEmptyState();
                showNotification('Error loading incidents', 'error');
            }
        }

        // ===== Show Empty State =====
        function showEmptyState() {
            emptyState.style.display = 'flex';
            incidentsList.innerHTML = '';
            incidentsList.appendChild(emptyState);
        }

        // ===== Display Incidents =====
        function displayIncidents(incidents) {
            incidentsList.innerHTML = '';

            incidents.forEach(incident => {
                const incidentItem = document.createElement('div');
                incidentItem.className = `incident-item ${getIncidentTypeClass(incident.type)}`;
                incidentItem.setAttribute('data-incident-id', incident.incident_id);

                const typeIcon = getIncidentTypeIcon(incident.type);
                const typeName = getIncidentTypeName(incident.type);
                const incidentDate = formatDateDisplay(incident.incident_time);
                const statusClass = getStatusClass(incident.is_resolved);
                const statusText = getStatusText(incident.is_resolved);

                const lat = parseFloat(incident.latitude || 0).toFixed(6);
                const lon = parseFloat(incident.longitude || 0).toFixed(6);

                const vehicle = vehicles.find(v => v.vehicle_id == incident.vehicle_id);
                const vehicleName = vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.license_plate})` : `Vehicle #${incident.vehicle_id}`;

                incidentItem.innerHTML = `
                <div class="incident-header">
                    <div class="incident-type">
                        <div class="incident-icon">
                            <i class="${typeIcon}"></i>
                        </div>
                        <div class="incident-type-info">
                            <div class="incident-type-name">${typeName}</div>
                            <div class="incident-date">
                                <i class="far fa-calendar"></i>
                                ${incidentDate}
                            </div>
                        </div>
                    </div>
                    <div class="incident-status ${statusClass}">${statusText}</div>
                </div>
                
                <div class="incident-details">
                    <div class="incident-description">
                        ${incident.description || 'No description provided'}
                    </div>
                    
                    <div class="incident-location">
                        <div class="location-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="location-info">
                            <div class="location-address">${incident.location_address || 'Location not specified'}</div>
                            <div class="gps-coords">GPS: ${lat}, ${lon}</div>
                        </div>
                    </div>
                </div>
                
                <div class="incident-meta">
                    <div>
                        <div style="font-size: 12px; color: var(--gray); margin-bottom: 3px;">Vehicle</div>
                        <div style="font-weight: 500; color: var(--dark);">${vehicleName}</div>
                    </div>
                    
                    <div class="incident-actions">
                        <button class="action-btn" onclick="viewIncidentDetails(${incident.incident_id})">
                            <i class="fas fa-eye"></i>
                            View Details
                        </button>
                        ${statusClass === 'status-pending' ? `
                        <button class="action-btn resolve" onclick="resolveIncident(${incident.incident_id})">
                            <i class="fas fa-check"></i>
                            Mark Resolved
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;

                incidentsList.appendChild(incidentItem);
            });
        }

        // ===== View Incident Details =====
        function viewIncidentDetails(incidentId) {
            const incident = incidents.find(i => i.incident_id == incidentId);
            if (!incident) {
                showNotification('Incident not found', 'error');
                return;
            }

            const typeName = getIncidentTypeName(incident.type);
            const incidentDate = formatDateDisplay(incident.incident_time);
            const statusClass = getStatusClass(incident.is_resolved);
            const statusText = getStatusText(incident.is_resolved);

            const lat = parseFloat(incident.latitude || 0).toFixed(6);
            const lon = parseFloat(incident.longitude || 0).toFixed(6);

            const vehicle = vehicles.find(v => v.vehicle_id == incident.vehicle_id);
            const vehicleName = vehicle ? `${vehicle.make} ${vehicle.model} (${vehicle.license_plate})` : `Vehicle #${incident.vehicle_id}`;

            document.getElementById('detailModalTitle').textContent = `${typeName} - Incident #${incidentId}`;

            const detailContent = document.getElementById('incidentDetailContent');
            detailContent.innerHTML = `
            <div style="margin-bottom: 25px;">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                    <div class="incident-status ${statusClass}" style="margin: 0;">
                        ${statusText}
                    </div>
                    <div style="font-size: 14px; color: var(--gray);">
                        <i class="far fa-calendar"></i>
                        ${incidentDate}
                    </div>
                </div>
                
                <div style="background-color: var(--gray-lighter); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="font-size: 15px; font-weight: 600; color: var(--dark); margin-bottom: 10px;">
                        Description
                    </div>
                    <div style="font-size: 14px; color: var(--dark); line-height: 1.6;">
                        ${incident.description || 'No description provided'}
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <div style="background-color: var(--gray-lighter); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 8px;">Vehicle</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--dark);">${vehicleName}</div>
                </div>
                
                <div style="background-color: var(--gray-lighter); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 8px;">Incident ID</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--dark);">#${incident.incident_id}</div>
                </div>
                
                <div style="background-color: var(--gray-lighter); padding: 20px; border-radius: 8px;">
                    <div style="font-size: 12px; color: var(--gray); margin-bottom: 8px;">Vehicle ID</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--dark);">#${incident.vehicle_id}</div>
                </div>
            </div>
            
            <div style="background-color: var(--gray-lighter); padding: 20px; border-radius: 8px;">
                <div style="font-size: 15px; font-weight: 600; color: var(--dark); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-map-marker-alt"></i>
                    Location Details
                </div>
                
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 13px; color: var(--gray); margin-bottom: 5px;">Address</div>
                    <div style="font-size: 14px; color: var(--dark); font-weight: 500;">
                        ${incident.location_address || 'Location not specified'}
                    </div>
                </div>
                
                <div>
                    <div style="font-size: 13px; color: var(--gray); margin-bottom: 5px;">GPS Coordinates</div>
                    <div style="font-family: monospace; font-size: 14px; color: var(--dark);">
                        Latitude: ${lat}<br>
                        Longitude: ${lon}
                    </div>
                </div>
            </div>
            
            ${statusClass === 'status-pending' ? `
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn btn-success" onclick="resolveIncident(${incident.incident_id}, true)">
                    <i class="fas fa-check"></i>
                    Mark Incident as Resolved
                </button>
            </div>
            ` : ''}
        `;

            document.getElementById('incidentDetailModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ===== Close Incident Detail Modal =====
        function closeIncidentDetailModal() {
            document.getElementById('incidentDetailModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // ===== Show Report Modal =====
        function showReportModal() {
            getCurrentLocation();
            document.getElementById('reportModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // ===== Close Report Modal =====
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
            document.getElementById('reportForm').reset();
            document.body.style.overflow = 'auto';
        }

        // ===== Get Current Location =====
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('gpsInfo').innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        <span>GPS Location: ${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}</span>
                    `;
                    },
                    (error) => {
                        console.error('GPS error:', error);
                        document.getElementById('gpsInfo').innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>GPS unavailable. Location will be recorded as (0, 0)</span>
                    `;
                    }
                );
            } else {
                document.getElementById('gpsInfo').innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>GPS not supported. Location will be recorded as (0, 0)</span>
            `;
            }
        }

        // ===== Report Incident =====
        async function reportIncident(event) {
            event.preventDefault();

            const vehicleId = document.getElementById('vehicleSelect').value;
            const type = document.getElementById('incidentType').value;
            const description = document.getElementById('description').value;

            // Validate inputs
            if (!vehicleId || !type || !description) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Get location
            let location = { latitude: 0, longitude: 0 };
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    location = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    };
                } catch (error) {
                    console.error('Failed to get location:', error);
                }
            }

            const incidentData = {
                operation: 'incident_report',
                session_id: sessionId,
                vehicle_id: vehicleId,
                type: type,
                latitude: location.latitude,
                longitude: location.longitude,
                description: description
            };

            console.log('Reporting incident:', incidentData);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(incidentData)
                });

                const data = await response.json();
                console.log('Report incident response:', data);

                if (data.status === 'success') {
                    showNotification('Incident reported successfully! Safety team has been notified.', 'success');
                    closeReportModal();

                    // Reload incidents and statistics
                    setTimeout(() => {
                        loadIncidents();
                        loadStatistics();
                    }, 500);
                } else {
                    showNotification(`Failed to report incident: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error reporting incident:', error);
                showNotification('Error reporting incident. Please try again.', 'error');
            }
        }

        // ===== Resolve Incident =====
        async function resolveIncident(incidentId, fromModal = false) {
            if (!confirm('Are you sure you want to mark this incident as resolved?')) {
                return;
            }

            console.log('Resolving incident:', incidentId);

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        operation: 'incident_resolve',
                        session_id: sessionId,
                        incident_id: parseInt(incidentId),
                        resolved: true,
                        resolution_notes: 'Marked as resolved by driver'
                    })
                });

                const data = await response.json();
                console.log('Incident resolve response:', data);

                if (data.status === 'success') {
                    showNotification('Incident marked as resolved!', 'success');
                    if (fromModal) {
                        closeIncidentDetailModal();
                    }

                    // Reload incidents and statistics
                    setTimeout(() => {
                        loadIncidents();
                        loadStatistics();
                    }, 500);
                } else {
                    console.error('Failed to resolve incident:', data.message);

                    // Check if backend operation is missing
                    if (data.message && data.message.includes('Unknown operation')) {
                        showNotification('Incident resolution feature not implemented in backend', 'warning');

                        // Update frontend state anyway for better UX
                        const incident = incidents.find(i => i.incident_id == incidentId);
                        if (incident) {
                            incident.is_resolved = '1';
                            displayIncidents(incidents);
                            loadStatistics();
                        }
                    } else {
                        showNotification(`Failed to resolve incident: ${data.message || 'Unknown error'}`, 'error');
                    }
                }
            } catch (error) {
                console.error('Error resolving incident:', error);
                showNotification(`Error resolving incident: ${error.message}`, 'error');
            }
        }

        // ===== Apply Filters =====
        function applyFilters() {
            loadIncidents();
            loadStatistics();
        }

        // ===== Reset Filters =====
        function resetFilters() {
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('vehicleFilter').value = 'all';

            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            document.getElementById('startDate').valueAsDate = thirtyDaysAgo;
            document.getElementById('endDate').valueAsDate = today;

            loadIncidents();
            loadStatistics();
        }

        // ===== Show Notification =====
        function showNotification(message, type = 'info') {
            // Remove any existing notification
            const existingNotification = document.querySelector('.notification-toast');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.className = `notification-toast ${type}`;
            notification.style.cssText = `
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 15px 20px;
            border-radius: 8px;
            background-color: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#007bff'};
            color: ${type === 'warning' ? '#212529' : 'white'};
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            cursor: pointer;
        `;

            const icon = type === 'success' ? 'fas fa-check-circle' :
                type === 'error' ? 'fas fa-exclamation-circle' :
                    type === 'warning' ? 'fas fa-exclamation-triangle' :
                        'fas fa-info-circle';
            notification.innerHTML = `<i class="${icon}"></i> ${message}`;

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 10);

            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 5000);

            // Click to dismiss
            notification.addEventListener('click', () => {
                notification.style.transform = 'translateX(150%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            });
        }

        // ===== Check Backend Operations =====
        async function checkBackendOperations() {
            console.log('=== Checking Backend Operations for Incidents ===');

            const operations = [
                'incident_report',
                'incident_get_list',
                'incident_get_statistics',
                'incident_resolve',
                'vehicle_get_list'
            ];

            for (const op of operations) {
                try {
                    console.log(`Testing operation: ${op}`);
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            operation: op,
                            session_id: sessionId,
                            // Add minimal test data for incident_report
                            ...(op === 'incident_report' ? {
                                vehicle_id: '1',
                                type: '5',
                                description: 'Test incident'
                            } : {})
                        })
                    });

                    const data = await response.json();
                    console.log(`${op} response:`, data);

                    if (data.status === 'error' && data.message && data.message.includes('Unknown operation')) {
                        console.error(`❌ ${op} NOT IMPLEMENTED in backend`);
                    } else if (data.status === 'success') {
                        console.log(`✓ ${op} SUCCESS`);
                    } else {
                        console.warn(`⚠ ${op} returned:`, data.message);
                    }
                } catch (error) {
                    console.error(`❌ ${op} ERROR:`, error);
                }
            }
        }

        // Uncomment to debug backend operations on page load
        // window.addEventListener('load', checkBackendOperations);

        // ===== Logout =====
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear local storage
                localStorage.clear();

                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        // ===== Utility Functions =====
        window.addEventListener('resize', function () {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
            });
        });

        // Close modals with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = 'auto';
            }
        });

        // ===== Fallback Data for Testing =====
        function getFallbackIncidents() {
            return [
                {
                    incident_id: 1,
                    driver_id: driverId,
                    vehicle_id: 1,
                    type: '0',
                    incident_time: Date.now() * 1000000 - 86400000000, // 1 day ago
                    latitude: 31.5204,
                    longitude: 74.3587,
                    location_address: 'Test Location',
                    description: 'Test incident reported for debugging',
                    is_resolved: '0'
                }
            ];
        }

        // ===== Load Fallback Data (for testing when backend is down) =====
        function loadFallbackData() {
            console.log('Loading fallback incident data for testing');

            incidents = getFallbackIncidents();

            // Display incidents
            displayIncidents(incidents);

            // Show content
            loadingState.style.display = 'none';
            emptyState.style.display = 'none';

            showNotification('Using demo data - Backend connection failed', 'warning');
        }

        // Uncomment to use fallback data for testing when backend is unavailable
        // window.addEventListener('load', function() {
        //     // Try to load real data first, fall back to demo data after 3 seconds
        //     setTimeout(() => {
        //         if (incidents.length === 0) {
        //             loadFallbackData();
        //         }
        //     }, 3000);
        // });
    </script>

